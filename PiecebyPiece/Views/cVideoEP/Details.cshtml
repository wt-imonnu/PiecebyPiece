@model PiecebyPiece.Models.mVideoEP
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
}

@Html.AntiForgeryToken()
@{
    string embedUrl = "";
    if (!string.IsNullOrEmpty(Model.vdoFilePath))
    {
        embedUrl = Model.vdoFilePath.Replace("watch?v=", "embed/");
    }
}

@{
    ViewData["Title"] = "Details";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}

<center><span class="header-title">Video Details</span></center>



<div class="box-body">
    <!-- Action Bar -->
    <div class="action-bar">
        <div class="left-actions">
            <a asp-controller="cLesson" asp-action="Details" asp-route-id="@Model?.lessonID" class="btn btn-mint-icon" aria-label="button"><i class="bi bi-arrow-left"></i></a>
            <a asp-controller="cVideoEP" asp-action="Edit" asp-route-id="@Model?.vdoID" class="btn btn-yellow-icon" aria-label="button"><i class="bi bi-pencil"></i></a>
        </div>

        <div class="right-actions">
            <a class="btn btn-pink-icon btn-delete-ep-modal" aria-label="button"
               data-delete-url="@Url.Action("Delete", "cVideoEP", new { id = Model?.vdoID })"
               data-ep-id="@Model?.vdoID"
               data-ep-name="@Model?.vdoName"
               data-lesson-id="@Model?.lessonID" href="#">
                <i class="bi bi-trash"></i>
            </a>
        </div>
    </div>



    <!-- Video Infomation -->
    <center>
        <div class="section-title">@Html.DisplayFor(model => model.vdoName)</div>
        <div class="card-id" style="margin-bottom: 20px;">#@Html.DisplayFor(model => model.lessonID) | @Html.DisplayFor(model => model.Lesson.lessonName)</div>
        @if (!string.IsNullOrEmpty(embedUrl))
        {
            <div style="width: 50%; max-width: 100%; margin: 0 auto;">
                <iframe src="@embedUrl"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen
                        style="width: 100%; aspect-ratio: 16 / 9; height: auto; display: block;">
                </iframe>
            </div>
        }
        else
        {
            <p>Video link is not valid.</p>
        }

    </center>
    <dl class="row" style="margin-top: 20px;">
        <dt class="col-sm-4">
            Youtube link:
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.vdoFilePath)
        </dd>
        <dt class="col-sm-4">
            File Download link:
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.epFilePath)
        </dd>
    </dl>
</div>



<div class="modal fade" id="deleteEpConfirmModal" tabindex="-1" aria-labelledby="deleteEpConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteEpConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Episode Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body text-start">
                <p class="mb-2"><strong>Are you sure you want to delete this episode?</strong></p>
                <p class="mb-1">All associated data will also be removed:</p>

                <ul class="list-unstyled ms-3">
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Video</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> File Download</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Related Data</li>
                </ul>

                <p class="mt-3 mb-3"><strong>This action cannot be undone.</strong></p>

                <p class="text-muted small">
                    ID: <strong id="epIdToDelete" class="text-danger"></strong> | Episode: <strong id="epNameToDelete" class="text-danger"></strong>
                </p>
            </div>

            <div class="modal-footer">
                <a id="confirmEpDeleteButton" class="btn btn-danger" aria-label="button">
                    Delete Episode
                </a>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="button">Cancel</button>


            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

            //<!-- Delete Episode -->
            var deleteEpModal = new bootstrap.Modal(document.getElementById('deleteEpConfirmModal'));
            var currentEpDeleteUrl = '';
            var redirectLessonId = 0; // ตัวแปรเก็บ Lesson ID

            $('.btn-delete-ep-modal').on('click', function (e) {
                e.preventDefault();

                currentEpDeleteUrl = $(this).data('delete-url');
                var epId = $(this).data('ep-id');
                var epName = $(this).data('ep-name');
                redirectLessonId = $(this).data('lesson-id'); // เก็บ Lesson ID

                $('#epIdToDelete').text(epId);
                $('#epNameToDelete').text(epName);

                deleteEpModal.show();
            });

            $('#confirmEpDeleteButton').on('click', function () {
                if (!currentEpDeleteUrl) return;

                deleteEpModal.hide();

                $.ajax({
                    url: currentEpDeleteUrl,
                    type: 'POST',
                    headers: { 'RequestVerificationToken': antiForgeryToken }, // ใช้อันเดียว
                    success: function (response) {
                        if (redirectLessonId > 0) {
                            window.location.href = '/cLesson/Details/' + redirectLessonId;
                        } else {
                            window.location.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("Error: Deletion failed. Please contact support.");
                        console.error("Deletion failed:", error);
                    }
                });
            });
        });
    </script>
}