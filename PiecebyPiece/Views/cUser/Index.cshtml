@model IEnumerable<PiecebyPiece.Models.mUSER>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var activeClass = "nav-item-active";
    var selectedSubjects = ViewBag.SelectedSubjects as List<string>;
}



<center><span class="header-title">User Panel</span></center>



<div class="box-body">
    <form asp-action="Index" method="get" id="filterForm" class="mb-3">
        <!-- Search -->
        <div class="input-group mb-2">
            <input type="text" name="cSearch" class="form-control custom-search-input" value="@Context.Request.Query["cSearch"]" placeholder="Search..." />
            <button class="btn-black" type="submit" aria-label="Search">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </form>

    <div>
        <!-- Section Header -->
        <div class="section-header mb-2" style="margin-top:50px;">
            <h5 class="section-title mb-0">All Users</h5>
            <a asp-action="Create" class="btn btn-black" aria-label="button">+ Create User</a>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 40%;">Fullname</th>
                    <th style="width: 30%;">Email</th>
                    <th style="width: 15%;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.userID</td>
                        <td>
                            <div class="text-wrap text-break">
                                @item.userName @item.userSurname
                            </div>
                        </td>
                        <td>
                            <div class="text-wrap text-break">
                                @item.userEmail
                            </div>
                        </td>

                        <td>
                            <a asp-action="Details" asp-route-id="@item.userID" class=" btn btn-black-icon" aria-label="button"><i class="bi bi-info-circle-fill"></i></a>
                            <a asp-action="Edit" asp-route-id="@item.userID" class="btn btn-yellow-icon" aria-label="button"><i class="bi bi-pencil"></i></a>
                            <a class="btn btn-pink-icon btn-delete-modal"
                               data-delete-url="@Url.Action("Delete", new { id = item.userID })"
                               data-user-id="@item.userID"
                               data-user-name="@item.userName"
                               data-user-surname="@item.userSurname"
                               href="#">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm User Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body text-start">
                <p class="mb-2"><strong>Are you sure you want to delete this user?</strong></p>
                <p class="mb-1">All associated data will also be removed:</p>
                <ul class="list-unstyled ms-3">
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Enrollment</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Certificate</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Related Data</li>
                </ul>
                <p class="mt-3 mb-3"><strong>This action cannot be undone.</strong></p>

                <p class="text-muted small">
                    ID: <strong id="userIdToDelete" class="text-danger"></strong> | User: <strong id="userNameToDelete" class="text-danger"></strong> <strong id="userSurnameToDelete" class="text-danger"></strong>
                </p>

                <form id="deleteForm" method="post" style="display: none;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="deleteUserIdInput" name="id" />
                </form>

            </div>

            <div class="modal-footer">
                <a id="confirmDeleteButton" class="btn btn-danger" aria-label="button">
                    Delete User
                </a>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="button">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            $('.btn-delete-modal').on('click', function (e) {
                e.preventDefault();

                var userId = $(this).data('user-id');
                var userName = $(this).data('user-name');
                var userSurname = $(this).data('user-surname');
                var deleteUrl = $(this).data('delete-url');

                $('#userIdToDelete').text(userId);
                $('#userNameToDelete').text(userName);
                $('#userSurnameToDelete').text(userSurname);

                $('#deleteUserIdInput').val(userId);
                $('#deleteForm').attr('action', deleteUrl);

                var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
            });

            $('#confirmDeleteButton').on('click', function () {
                $('#deleteForm').submit();
            });
        });
    </script>
}