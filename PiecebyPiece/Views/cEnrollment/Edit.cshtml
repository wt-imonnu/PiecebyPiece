@model PiecebyPiece.Models.mENROLLMENT

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}

<center><span class="header-title">Edit Enrollment</span></center>

@if (ViewBag.EnrollError != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Warning!</strong> @ViewBag.EnrollError
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" aria-label="button"></button>
    </div>
}

<div class="row">
    <form asp-action="Edit">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="enrollID" />
        <input type="hidden" asp-for="enrollTime" />
        <input type="hidden" asp-for="userID" />

        <div class="box-body-sm">
            <div class="row">
                <div class="form-group">
                    <center><span class="form-control-plaintext fw-bold">@ViewData["UserNameDisplay"]</span></center>
                </div>
            </div>

            <div class="row" style="margin-bottom: 50px;">
                <div class="form-group">
                    <label asp-for="courseID" class="control-label">Change enrolled course</label>
                    <select asp-for="courseID" class="form-control d-none" id="courseIDSelect" asp-items="ViewBag.courseID"></select>
                    <input type="hidden" asp-for="courseID" id="hiddenCourseID" />

                    <div class="dropdown custom-dropdown-container" data-target-id="courseIDSelect" data-hidden-id="hiddenCourseID">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                                type="button"
                                id="courseIDDropdownButton"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="courseIDDropdownButton"></ul>
                    </div>
                    <span asp-validation-for="courseID" class="text-danger"></span>
                </div>
            </div>

        </div>

        <div class="row" style="margin-top: 10px;">
            <div class="col-md-6 mb-2">
                <a asp-action="Index" class="btn-cancel" aria-label="button">Cancle</a>
            </div>
            <div class="col-md-6">
                <input type="submit" value="Save" class="btn-save" aria-label="button" />
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>

        function initializeCustomDropdown(containerSelector) {
            const $container = $(containerSelector);
            const targetSelectId = $container.data('target-id');
            const hiddenInputId = $container.data('hidden-id');
            const $originalSelect = $('#' + targetSelectId);
            const $hiddenInput = $('#' + hiddenInputId);
            const $dropdownButton = $container.find('.dropdown-toggle');
            const $dropdownList = $container.find('.dropdown-menu');
            const placeholderText = $dropdownButton.text().trim() || "-- Select Option --";

            $dropdownList.empty();

            $originalSelect.find('option').each(function () {
                const $option = $(this);
                const value = $option.val();
                const text = $option.text().trim();
                const $listItem = $('<li>');
                const $anchor = $('<a>')
                    .addClass('dropdown-item custom-dropdown-item')
                    .attr('href', '#')
                    .data('value', value)
                    .text(text);

                $listItem.append($anchor);
                $dropdownList.append($listItem);
            });

            $dropdownList.on('click', '.custom-dropdown-item', function (e) {
                e.preventDefault();

                const $clickedItem = $(this);
                const selectedValue = $clickedItem.data('value');
                const selectedText = $clickedItem.text().trim();

                $hiddenInput.val(selectedValue).trigger('change');
                $originalSelect.val(selectedValue).trigger('change');

                if (selectedValue === "") {
                    $dropdownButton.text(placeholderText);
                } else {
                    $dropdownButton.text(selectedText);
                }

                const validationTarget = $hiddenInput.attr('asp-for') || $hiddenInput.attr('name');
                $(`span[data-valmsg-for="${validationTarget}"]`).text('');
            });

            const initialValue = $originalSelect.val();
            if (initialValue) {
                const $initialItem = $dropdownList.find(`.custom-dropdown-item[data-value="${initialValue}"]`);
                if ($initialItem.length) {
                     $dropdownButton.text($initialItem.text().trim());
                } else if (initialValue === "") {
                     $dropdownButton.text(placeholderText);
                }
            } else {
                 $dropdownButton.text(placeholderText);
            }
        }

        $(document).ready(function () {
            initializeCustomDropdown('[data-target-id="courseIDSelect"]');
        });
    </script>
}