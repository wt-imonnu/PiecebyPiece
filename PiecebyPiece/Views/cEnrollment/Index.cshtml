@model IEnumerable<PiecebyPiece.Models.mENROLLMENT>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";

    var subjects = new List<string> { "MTH", "PROD", "COD", "PHY", "ART" };
    var selectedSubjects = (List<string>)ViewBag.SelectedSubjects;
    var currentSort = (string)ViewBag.CurrentSort ?? "time_desc";
    var currentStatusFilter = (string)ViewBag.CurrentStatusFilter ?? "All";

    if (selectedSubjects == null) selectedSubjects = new List<string>();

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var activeClass = "nav-item-active";

}



<center><span class="header-title">Enrollment Panel</span></center>




<div class="box-body">
    <form asp-action="Index" method="get" id="filterForm" class="mb-3">
        <!-- Search -->
        <div class="input-group mb-2">
            <input type="text" name="cSearch" class="form-control custom-search-input" value="@Context.Request.Query["cSearch"]" placeholder="Search..." />
            <button class="btn-black" type="submit" aria-label="Search">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <!-- Filter -->
        <div class="d-flex align-items-center flex-wrap gap-3 mb-4">

            <div class="d-flex align-items-center flex-wrap gap-2">
                <span class="fw-semibold" style="color:#49454F;">Subject Filter:</span>

                <div class="d-flex flex-wrap gap-1" onchange="this.form.submit()">
                    @foreach (var subject in subjects)
                    {
                        bool isActive = selectedSubjects.Contains(subject);
                        <input type="checkbox" class="btn-check subject-filter" name="cFilter" value="@subject" id="btn-@subject" autocomplete="off" @(isActive ? "checked" : "") />
                        <label class="btn-filter @(isActive ? "active" : "")" for="btn-@subject">@subject.ToUpper()</label>
                    }
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 ms-4 custom-filter-dropdown">
                <span class="fw-semibold" style="color:#49454F;">Status:</span>

                <input type="hidden" name="enrollStatusFilter" id="hiddenStatusFilter" value="@currentStatusFilter" />

                <div class="dropdown" data-filter-name="enrollStatusFilter" data-placeholder="All" data-current-value="@currentStatusFilter">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle text-start"
                            type="button"
                            id="statusDropdownButton"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            style="width: 150px;">
                        @currentStatusFilter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="statusDropdownButton">
                        <li><a class="dropdown-item filter-item" href="#" data-value="All">All</a></li>
                        <li><a class="dropdown-item filter-item" href="#" data-value="In Progress">In Progress</a></li>
                        <li><a class="dropdown-item filter-item" href="#" data-value="Completed">Completed</a></li>
                    </ul>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 ms-4 custom-filter-dropdown">
                <span class="fw-semibold" style="color:#49454F;">Sort By:</span>

                <input type="hidden" name="sortOrder" id="hiddenSortOrder" value="@currentSort" />

                <div class="dropdown" data-filter-name="sortOrder" data-placeholder="Decending" data-current-value="@currentSort">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle text-start"
                            type="button"
                            id="sortDropdownButton"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            style="width: 200px;">
                        @(currentSort == "time_asc" ? "Ascending" : "Decending")
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sortDropdownButton">
                        <li><a class="dropdown-item filter-item" href="#" data-value="time_desc">Decending</a></li>
                        <li><a class="dropdown-item filter-item" href="#" data-value="time_asc">Ascending</a></li>
                    </ul>
                </div>
            </div>

        </div>
    </form>

    <div>
        <!-- Section Header -->
        <div class="section-header mb-2" style="margin-top:50px;">
            <h5 class="section-title mb-0">All Enrollments</h5>
            <a asp-action="Create" class="btn btn-black" aria-label="button">+ Enroll</a>
        </div>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 15%;">Date</th>
                    <th style="width: 20%;">Fullname</th>
                    <th style="width: 30%;">Course</th>
                    <th style="width: 15%;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.enrollID</td>
                        <td>
                            @item.enrollTime.ToShortDateString()
                            @{
                                string status = item.enrollStatus;
                                string badgeClass = status == "Completed" ? "bg-success" : "bg-primary";
                            }
                            <span class="badge @badgeClass" style="font-size: 0.75em;">
                                @status
                            </span>
                        </td>
                        <td>
                            <div class="text-wrap text-break">
                                @item.User.userName @item.User.userSurname
                            </div>
                        </td>
                        <td>
                            <div class="text-wrap text-break">
                                #@item.Course.courseID | @item.Course.courseName
                            </div>
                        </td>
                        <td>

                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@item.enrollID" class="btn btn-black-icon btn-sm" aria-label="button"><i class="bi bi-info-circle-fill"></i></a>
                            <a asp-action="Edit" asp-route-id="@item.enrollID" class="btn btn-yellow-icon btn-sm" aria-label="button"><i class="bi bi-pencil"></i></a>
                            <a class="btn btn-pink-icon btn-sm btn-delete-modal"
                               data-delete-url="@Url.Action("Delete", new { id = item.enrollID })"
                               data-enroll-id="@item.enrollID"
                               data-user-id="@item.userID"
                               data-enroll-course="@item.Course.courseName"
                               href="#">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>


</div>



<div class="modal fade" id="deleteCourseConfirmModal" tabindex="-1" aria-labelledby="deleteCourseConfirmModalLabel" aria-hidden="true">

    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCourseConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Course Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>


            <div class="modal-body text-start">
                <p class="mb-2"><strong>Are you sure you want to delete this course?</strong></p>
                <p class="mb-1">All associated data will also be removed:</p>
                <ul class="list-unstyled ms-3">
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Lessons</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Tests</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Related Data (e.g., Certificate links)</li>
                </ul>
                <p class="mt-3 mb-3"><strong>This action cannot be undone.</strong></p>
                <p class="text-muted small">
                    ID: <strong id="enrollIdToDelete" class="text-danger"></strong> | Course: <strong id="courseNameToDelete" class="text-danger"></strong> | User: <strong id="userIdToDelete" class="text-danger"></strong>
                </p>
                <form id="deleteEnrollmentForm" method="post" style="display: none;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="deleteEnrollmentIdInput" name="id" />
                </form>
            </div>



            <div class="modal-footer">
                <a id="confirmCourseDeleteButton" class="btn btn-danger" aria-label="button">
                    Disenrollment
                </a>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="button">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.btn-delete-modal').on('click', function (e) {
                e.preventDefault();

                var enrollId = $(this).data('enroll-id');
                var userId = $(this).data('user-id');
                var courseName = $(this).data('enroll-course');
                var deleteUrl = $(this).data('delete-url');

                $('#enrollIdToDelete').text(enrollId);
                $('#courseNameToDelete').text(courseName);
                $('#userIdToDelete').text(userId);
                $('#deleteEnrollmentIdInput').val(enrollId);
                $('#deleteEnrollmentForm').attr('action', deleteUrl);

                var deleteCourseModal = new bootstrap.Modal(document.getElementById('deleteCourseConfirmModal'));
                deleteCourseModal.show();
            });

            $('#confirmCourseDeleteButton').on('click', function () {
                $('#deleteEnrollmentForm').submit();
            });
        });

        $(document).ready(function () {
            function initializeFilterDropdown(containerElement) {
                const $container = $(containerElement);
                const filterName = $container.data('filter-name');
                const $hiddenInput = $(`input[name="${filterName}"]`);
                const $dropdownButton = $container.find('.dropdown-toggle');
                const $dropdownItems = $container.find('.filter-item');
                const initialText = $dropdownItems.filter(`[data-value="${$hiddenInput.val()}"]`).text().trim();
                if (initialText) {
                    $dropdownButton.text(initialText);
                }
                $dropdownItems.on('click', function(e) {
                    e.preventDefault();

                    const $clickedItem = $(this);
                    const selectedValue = $clickedItem.data('value');
                    const selectedText = $clickedItem.text().trim();
                    const form = $hiddenInput.closest('form');

                    $hiddenInput.val(selectedValue);
                    $dropdownButton.text(selectedText);

                    if (form.length) {
                        form.submit();
                    }
                });
            }

            $('.custom-filter-dropdown .dropdown').each(function() {
                initializeFilterDropdown(this);
            });
        });
    </script>
}