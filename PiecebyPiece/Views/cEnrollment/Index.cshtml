@model IEnumerable<PiecebyPiece.Models.mENROLLMENT>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";

    var subjects = new List<string> { "MTH", "PROD", "COD", "PHY", "ART" };
    var selectedSubjects = (List<string>)ViewBag.SelectedSubjects;
    var currentSort = (string)ViewBag.CurrentSort ?? "time_desc";
    var currentStatusFilter = (string)ViewBag.CurrentStatusFilter ?? "All";

    if (selectedSubjects == null) selectedSubjects = new List<string>();
}



<center><span class="header-title">Enrollment Panel</span></center>



@{
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();

    var activeClass = "nav-item-active";
}

<style>
    .nav-item-active {
        border-radius: 100px;
        background-color: #5AB2A6;
        transition: all 0.3s ease;
        text-decoration: none;
    }

        .nav-item-active .nav-link {
            color: #fff !important;
            text-decoration: none;
        }
</style>
<div class="box-body" style="padding: 10px; margin-bottom: 20px;">
    <div class="d-flex justify-content-center" style="white-space: nowrap;">
        <ul class="nav nav-pills admin-sub-nav">
            <li class="nav-item @(currentController == "cEnrollment" ? activeClass : "")" style="margin: 0 5px;">
                <a class="nav-link text-dark" asp-area="" asp-controller="cEnrollment" asp-action="Index" style="font-weight:600;">Enrollment</a>
            </li>
            <li class="nav-item @(currentController == "cCourse" ? activeClass : "")" style="margin: 0 5px;">
                <a class="nav-link text-dark" asp-area="" asp-controller="cCourse" asp-action="Index" style="font-weight:600;">Course</a>
            </li>
            <li class="nav-item @(currentController == "cCertificate" ? activeClass : "")" style="margin: 0 5px;">
                <a class="nav-link text-dark" asp-area="" asp-controller="cCertificate" asp-action="Index" style="font-weight:600;">Certificate</a>
            </li>
            <li class="nav-item @(currentController == "cUser" ? activeClass : "")" style="margin: 0 5px;">
                <a class="nav-link text-dark" asp-area="" asp-controller="cUser" asp-action="Index" style="font-weight:600;">User</a>
            </li>
            <li class="nav-item @(currentController == "cAdminPanel" ? activeClass : "")" style="margin: 0 5px;">
                <a class="nav-link text-dark" asp-area="" asp-controller="cAdminPanel" asp-action="Index" style="font-weight:600;">Admin</a>
            </li>
        </ul>
    </div>
</div>



<div class="box-body">
    <form asp-action="Index" method="get" id="filterForm" class="mb-3">
        <!-- Search -->
        <div class="input-group mb-2">
            <input type="text" name="cSearch" class="form-control custom-search-input" value="@Context.Request.Query["cSearch"]" placeholder="Search..." />
            <button class="btn-black" type="submit" aria-label="Search">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <!-- Filter -->
        <div class="d-flex align-items-center flex-wrap gap-3 mb-4">

            <div class="d-flex align-items-center flex-wrap gap-2">
                <i class="bi bi-funnel-fill filter-icon me-2" style="color:#49454F;"></i>
                <span class="fw-semibold" style="color:#49454F;">Subject Filter:</span>

                <div class="d-flex flex-wrap gap-1" onchange="this.form.submit()">
                    @foreach (var subject in subjects)
                    {
                        bool isActive = selectedSubjects.Contains(subject);
                        <input type="checkbox" class="btn-check subject-filter" name="cFilter" value="@subject" id="btn-@subject" autocomplete="off" @(isActive ? "checked" : "") />
                        <label class="btn-filter @(isActive ? "active" : "")" for="btn-@subject">@subject.ToUpper()</label>
                    }
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 ms-4">
                <span class="fw-semibold" style="color:#49454F;">Status:</span>
                <select name="enrollStatusFilter" class="form-select form-select-sm" style="width: 150px;" onchange="this.form.submit()">

                    <option value="All" selected="@(currentStatusFilter == "All" ? "selected" : null)">All</option>
                    <option value="In Progress" selected="@(currentStatusFilter == "In Progress" ? "selected" : null)">In Progress</option>
                    <option value="Completed" selected="@(currentStatusFilter == "Completed" ? "selected" : null)">Completed</option>

                </select>
            </div>

            <div class="d-flex align-items-center gap-2 ms-4">
                <span class="fw-semibold" style="color:#49454F;">Sort By:</span>
                <select name="sortOrder" class="form-select form-select-sm" style="width: 200px;" onchange="this.form.submit()">

                    <option value="time_desc" selected="@(currentSort == "time_desc" ? "selected" : null)">Decending</option>
                    <option value="time_asc" selected="@(currentSort == "time_asc" ? "selected" : null)">Ascending</option>

                </select>
            </div>

        </div>
    </form>

    <div>
        <!-- Section Header -->
        <div class="section-header mb-2" style="margin-top:50px;">
            <h5 class="section-title mb-0">All Enrollments</h5>
            <a asp-action="Create" class="btn btn-black" aria-label="button">+ Enroll</a>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Fullname</th>
                    <th>Course</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@Html.DisplayFor(modelItem => item.enrollID)</td>
                        <td>@Html.DisplayFor(modelItem => item.enrollTime)</td>
                        <td>@Html.DisplayFor(modelItem => item.User.userName) @Html.DisplayFor(modelItem => item.User.userSurname)</td>
                        <td>@Html.DisplayFor(modelItem => item.Course.courseName)</td>
                        <td>@Html.DisplayFor(modelItem => item.enrollStatus)</td>
                        <td>
                            <a asp-action="Details" asp-route-id="@item.enrollID" class=" btn btn-black-icon" aria-label="button"><i class="bi bi-info-circle-fill"></i></a>
                            <a asp-action="Edit" asp-route-id="@item.enrollID" class="btn btn-yellow-icon" aria-label="button"><i class="bi bi-pencil"></i></a>
                            <a class="btn btn-pink-icon btn-delete-modal"
                               data-delete-url="@Url.Action("Delete", new { id = item.enrollID })"
                               data-enroll-id="@item.enrollID"
                               data-user-id="@item.userID"
                               data-enroll-course="@item.courseName"
                               href="#">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>


</div>



<div class="modal fade" id="deleteCourseConfirmModal" tabindex="-1" aria-labelledby="deleteCourseConfirmModalLabel" aria-hidden="true">

    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCourseConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Course Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>


            <div class="modal-body text-start">
                <p class="mb-2"><strong>Are you sure you want to delete this course?</strong></p>
                <p class="mb-1">All associated data will also be removed:</p>
                <ul class="list-unstyled ms-3">
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Lessons</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Tests</li>
                    <li><i class="bi bi-x-circle-fill text-danger me-2"></i> Related Data (e.g., Certificate links)</li>
                </ul>
                <p class="mt-3 mb-3"><strong>This action cannot be undone.</strong></p>
                <p class="text-muted small">
                    ID: <strong id="enrollIdToDelete" class="text-danger"></strong> | Course: <strong id="courseNameToDelete" class="text-danger"></strong> | User: <strong id="userIdToDelete" class="text-danger"></strong>
                </p>
                <form id="deleteEnrollmentForm" method="post" style="display: none;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="deleteEnrollmentIdInput" name="id" />
                </form>
            </div>



            <div class="modal-footer">
                <a id="confirmCourseDeleteButton" class="btn btn-danger" aria-label="button">
                    Disenrollment
                </a>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="button">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.btn-delete-modal').on('click', function (e) {
                e.preventDefault();

                var enrollId = $(this).data('enroll-id');
                var userId = $(this).data('user-id');
                var courseName = $(this).data('enroll-course');
                var deleteUrl = $(this).data('delete-url');

                $('#enrollIdToDelete').text(enrollId);
                $('#courseNameToDelete').text(courseName);
                $('#userIdToDelete').text(userId);
                $('#deleteEnrollmentIdInput').val(enrollId);
                $('#deleteEnrollmentForm').attr('action', deleteUrl);

                var deleteCourseModal = new bootstrap.Modal(document.getElementById('deleteCourseConfirmModal'));
                deleteCourseModal.show();
            });

            $('#confirmCourseDeleteButton').on('click', function () {
                $('#deleteEnrollmentForm').submit();
            });
        });
    </script>
}